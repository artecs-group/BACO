#--------------------------------------------------------------------------------
# Compiler flags
#--------------------------------------------------------------------------------
CXX      = g++
CXXFLAGS = -std=c++11 -fPIC
EXTRA    = -Wall -Wextra $(firstword $(subst ., ,-D$(shell hostname)))



#--------------------------------------------------------------------------------
# Project files
#--------------------------------------------------------------------------------
SRCS = $(notdir $(wildcard *.cpp))
OBJS = $(notdir $(patsubst %.cpp,%.o,$(SRCS)))
DEPS = 



#--------------------------------------------------------------------------------
# Project configs
#--------------------------------------------------------------------------------
INCS = 
LIBS = 



#--------------------------------------------------------------------------------
# RELEASE build settings
#--------------------------------------------------------------------------------
RELDIR = release
RELOBJS = $(addprefix $(RELDIR)/, $(OBJS))
RELCXXFLAGS = -O3
RELINCS =
RELLIBS =



#--------------------------------------------------------------------------------
# DEBUG build settings
#--------------------------------------------------------------------------------
DBGDIR = debug
DBGOBJS = $(addprefix $(DBGDIR)/, $(OBJS))
DBGCXXFLAGS = -O0 -ggdb3 -DDEBUG
DBGINCS =
DBGLIBS =



#--------------------------------------------------------------------------------
# INSTRUMENTATION build settings
#--------------------------------------------------------------------------------
INSTRDIR = instrumentation
INSTROBJS = $(addprefix $(INSTRDIR)/, $(OBJS))
INSTRCXXFLAGS = -DINSTR
INSTRINCS = -I$(EXTRAE_INC)
INSTRLIBS = -L$(EXTRAE_LIB) -lpttrace



#--------------------------------------------------------------------------------
# RULES
#--------------------------------------------------------------------------------


$(info *********************************)
$(info ************  COMMON ************)
$(info *********************************)


.PHONY: all clean prep remake release debug instrument


# Default build
all: prep release debug instrument

#--------------------------------------------------------------------------------
# DEBUG rules
#--------------------------------------------------------------------------------
debug: $(DBGOBJS)

$(DBGDIR)/%.o:  %.cpp
	$(CXX) -c $(CXXFLAGS) $(DBGCXXFLAGS) $(INCS) $(DBGINCS) -o $@ $<



#--------------------------------------------------------------------------------
# RELEASE rules
#--------------------------------------------------------------------------------
release: $(RELOBJS)

$(RELDIR)/%.o: %.cpp
	$(CXX) -c $(CXXFLAGS) $(RELCXXFLAGS) $(INCS) $(RELINCS) -o $@ $<


#--------------------------------------------------------------------------------
# INSTRUMENTATION rules
#--------------------------------------------------------------------------------
instrument: $(INSTROBJS)

$(INSTRDIR)/%.o: %.cpp
	$(CXX) -c $(CXXFLAGS) $(INSTRCXXFLAGS) $(INCS) $(INSTRINCS) -o $@ $<



#--------------------------------------------------------------------------------
# Other rules
#--------------------------------------------------------------------------------
prep:
	@mkdir -p $(DBGDIR) $(RELDIR) $(INSTRDIR)

remake: clean all

clean:
	rm -f $(RELOBJS) $(DBGOBJS) $(INSTROBJS)
